<!DOCTYPE html>

<html>

<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title> MapChat </title>
	<script type = "text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"> </script>
	<link rel = "stylesheet" href = "style.css" type = "text/css" />

	<script>
	var myLat = 0;
	var myLng = 0;
	var request = new XMLHttpRequest();
	var myOptions = {
		center: new google.maps.LatLng(myLat, myLng),
		zoom: 13,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var jsondata;



	function printLocation() {
		elem = document.getElementById("location");
		elem.innerHTML = "<p>" + myLat + ", " + myLng + "</p>";
	}


	function sendLocToDatabase() {
		// Variables for Database API
		var request = new XMLHttpRequest();
		var url = "https://secret-about-box.herokuapp.com/sendLocation";
		request.open("POST", url, true);
		request.setRequestHeader('Content-Type', "application/x-www-form-urlencoded");
		var send_str = "login=CalvinMoseley&lat=" + myLat.toString() + "&lng=" + myLng.toString() + "&message=yo";
		request.send(send_str);

		request.onreadystatechange = function() {
			if (request.readyState == 4 && request.status == 200) {
				// alert(request.responseText);
				var jsondata = JSON.parse(request.responseText);
				for (var count = 0; count < jsondata.length; count++) {
					renderMap(jsondata[count]["login"],
							  jsondata[count]["lat"],
							  jsondata[count]["lng"],
							  jsondata[count]["message"]);
				}
			}
		}
	}

	
 	/* Inspired by Tufts Dev example of Google Maps API */
	function renderMap(login, lat, lng, message) {
		var personLoc = new google.maps.LatLng(lat, lng);
		// update map and go there
		map.panTo(personLoc);
		// Create a marker
		var marker = new google.maps.Marker(
		{
			position: personLoc, 
			title: login
		});
		marker.setMap(map);
		console.log("Before info window")
		// Open info window on click of marker
		
		//info window stuff doesnt work now....
		/*google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(marker.title);
			infowindow.open(map, marker);
		});*/
	}

	function getMyLocation() {
			console.log("Hey");
			navigator.geolocation.getCurrentPosition(function(position) {
				myLat = position.coords.latitude;
				myLng = position.coords.longitude;
				printLocation();	// just prints lat and lng to the page
				renderMap();			// prints the whole map
				sendLocToDatabase();  //sends MY location to the Database API
			});
			console.log("Heya");
	}
	
	function initMap() { //prints the whole map
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		getMyLocation();
	}
	

	</script>


</head>



<body onload = "initMap()">
	<h1>Map Chat </h1>
	<div id = "map_canvas"> </div>
	<div id = "location"> </div>
</body>

</html>