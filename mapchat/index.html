/*
README 
	Things To Do:
	- Make InfoWindow pop up for everyone
	- Have a separate function that renders map/creates infowindow for MY location
		and has a unique icon for MY location
	- Make a function to calculate the distance of other people to my location
	- Clean up code



*/









<!DOCTYPE html>

<html>

<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title> MapChat </title>
	<script type = "text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"> </script>
	<link rel = "stylesheet" href = "style.css" type = "text/css" />
	<link href='https://fonts.googleapis.com/css?family=Amatic+SC:400,700' rel='stylesheet' type='text/css' />

	<script>
	var myLat = 0;
	var myLng = 0;
	var myName = "CalvinMoseley";
	var request = new XMLHttpRequest();
	var myOptions = {
		center: new google.maps.LatLng(myLat, myLng),
		zoom: 13,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var jsondata;

	

	function printLocation() {
		elem = document.getElementById("location");
		elem.innerHTML = "<p>" + myLat + ", " + myLng + "</p>";
	}


	function sendLocToDatabase() {
		// Variables for Database API
		var request = new XMLHttpRequest();
		var url = "https://secret-about-box.herokuapp.com/sendLocation";
		request.open("POST", url, true);
		request.setRequestHeader('Content-Type', "application/x-www-form-urlencoded");
		var send_str = "login=CalvinMoseley&lat=" + myLat.toString() + "&lng=" + myLng.toString() + "&message=yo";
		request.send(send_str);

		request.onreadystatechange = function() {
			if (request.readyState == 4 && request.status == 200) {
				// alert(request.responseText);
				var jsondata = JSON.parse(request.responseText);
				for (var count = 0; count < jsondata.length; count++) {
					renderMap(jsondata[count]["login"],
							  jsondata[count]["lat"],
							  jsondata[count]["lng"],
							  jsondata[count]["message"]);
				}
			}
		}
	}



	function renderMe() {
		var me = new google.maps.LatLng(myLat+1, myLng+1);
		var contentString = '<div id = "content">' 
			+ '<h1 id = "Login">Login Name: ' 
			+ myName 
			+ '</h1>'
			+ '<h1 id = "Message"> Message: '
			+ 'I have successfully logged in!' 
			+ '</h1>'
			+ '</div>';
		var infowindow = new google.maps.InfoWindow({
			content: contentString
		});	

		// My custom Image 
		var meImage = {
			url: 'fatcat.jpg'
			//size: new google.maps.Size(5, 5),
		};

		var meMarker = new google.maps.Marker({
			position: me,
			icon: meImage,
			title: "MyLocation"
		});

		meMarker.setMap(map);

		meMarker.addListener('click', function() {
			infowindow.open(map, meMarker);
		});


	}

	
 	/* Inspired by Tufts Dev example of Google Maps API */
	function renderMap(login, lat, lng, message) {
		if (login == myName) {renderMe();}
		var personLoc = new google.maps.LatLng(lat, lng);
		
		var contentString = '<div id = "content">' 
			+ '<h1 id = "Login">Login Name: ' 
			+ login 
			+ '</h1>'
			+ '<h1 id = "Message"> Message: '
			+ message 
			+ '</h1>'
			+ '<h1 id = "Miles"> Miles: '
			+ 10000000
			+ '</h1>'
			+ '</div>';

		var infowindow = new google.maps.InfoWindow({
			content: '<div id = "info_window">' +contentString +
				'</div>'
		});

		// Create a marker
		var marker = new google.maps.Marker(
		{
			position: personLoc, 
			title: login
		});

		marker.setMap(map);

		//info window stuff doesnt work now....
		marker.addListener('click', function() {
			infowindow.open(map, marker);
		});
	}




	function getMyLocation() {
			console.log("Hey");
			navigator.geolocation.getCurrentPosition(function(position) {
				myLat = position.coords.latitude;
				myLng = position.coords.longitude;
			//	printLocation();	// just prints lat and lng to the page
				sendLocToDatabase();  //sends MY location to the Database API
				// update map and go there
				var myLoc = new google.maps.LatLng(myLat, myLng)
				map.panTo(myLoc);
			});
			console.log("Heya");
	}
	
	function initMap() { //prints the whole map
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		getMyLocation();
	}
	

	</script>


</head>



<body onload = "initMap()">
	<h1>Map Chat </h1>
	<div id = "map_canvas"> </div>
	<div id = "location"> </div>
</body>

</html>